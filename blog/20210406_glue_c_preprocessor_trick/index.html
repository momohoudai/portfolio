<html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=https://www.w3schools.com/w3css/4/w3.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata">
<link rel=stylesheet href=/css/common.css>
<link rel="shortcut icon" type=image/png href=/img/favicon.png>
<title>Gerald's Website</title>
<script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}},window.addEventListener('load',a=>{document.querySelectorAll("mjx-container").forEach(function(a){a.parentElement.classList+='has-jax'})})</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>
</head>
<body>
<div class=profile>
<a href=/>
<img class=profile-img-back src=/img/profile.jpg loading=lazy>
</a>
<div class=profile-text>Gerald's Stuff</div>
<div class=profile-subtext> Blog </div>
</div>
<div class=blog-container>
<div class=blog-body>
<h1 class=blog-content-title>
'Glue' C-preprocessor trick
</h1>
<h4 class=blog-content-date>
<time datetime=2021-04-06T12:00:00+08:00>
Apr 6, 2021
</time>
</h4>
<p class=blog-content-body>
<p>Macro tricks are rare to find nowadays. Sometimes, I would code and <em>know</em> of a trick but had forgotten how to go about implementing it because they can look as arcane as Template Metaprogramming. Hopefully, I can document some of my knowledge of these tricks in this blog. Here, I will introduce what I call the &lsquo;Glue&rsquo; macro trick.</p>
<p>Let&rsquo;s start with a problem. I&rsquo;ll use a simple example from my project. Suppose I have a simple struct that represents a string, and provide a simple function that acts as a constructor:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:navy;font-weight:700>struct</span> string {
    <span style=color:navy;font-weight:700>unsigned</span> Count;
    <span style=color:navy;font-weight:700>char</span> *Buffer;
};

string CreateString(<span style=color:navy;font-weight:700>char</span>* Buffer, <span style=color:navy;font-weight:700>unsigned</span> Count) {
    string Ret = {};
    Ret.Buffer = Buffer;
    Ret.Count = Count;
}
</code></pre></td></tr></table>
</div>
</div><p>And the way to easily initialize such a struct might be something like this:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:navy;font-weight:700>char</span> tempBuffer[<span style=color:#00f>256</span>] = {};
string Str = CreateString(tempBuffer, <span style=color:#00f>256</span>);
</code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s terribly unwieldy. We might end up in an ugly scenario where it looks like this:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:navy;font-weight:700>char</span> tempBuffer1[<span style=color:#00f>256</span>] = {};
string Str1 = CreateString(tempBuffer1, <span style=color:#00f>256</span>);

<span style=color:navy;font-weight:700>char</span> tempBuffer2[<span style=color:#00f>128</span>] = {};
string Str2 = CreateString(tempBuffer2, <span style=color:#00f>128</span>);

<span style=color:navy;font-weight:700>char</span> tempBuffer3[<span style=color:#00f>64</span>] = {};
string Str3 = CreateString(tempBuffer3, <span style=color:#00f>64</span>);

<span style=color:navy;font-weight:700>char</span> tempBuffer4[<span style=color:#00f>32</span>] = {};
string Str4 = CreateString(tempBuffer4, <span style=color:#00f>32</span>);
</code></pre></td></tr></table>
</div>
</div><p>But we see some hope! There is a pattern in the code so we decide to use macro concatenation to help us make the code look cleaner. We hope to achieve something like below which will expand to the code above:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>CreateStackString(Str1, <span style=color:#00f>256</span>);
CreateStackString(Str2, <span style=color:#00f>128</span>);
CreateStackString(Str3, <span style=color:#00f>64</span>);
CreateStackString(Str4, <span style=color:#00f>32</span>);
</code></pre></td></tr></table>
</div>
</div><p>So now, we will try to implement the macro. We start off naively by trying to define a macro based on what we want to substitute.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp> <span style=color:teal>#define CreateStackString(Name, Num) \ char tempBuffer[Num] = {}; \ string Name = CreateString(tempBuffer, Num)
</span></code></pre></td></tr></table>
</div>
</div><p>This would be good for one call, but subsequent calls would cause an error because <code>tempBuffer</code> would be redefined. What we kind of want is some kind of unique id to attach to <code>tempBuffer</code>. A common way is to use the <code>__LINE__</code> macro definition that will evaluate to the document&rsquo;s line number. It might not work for all cases, but for this case, it is good enough because it&rsquo;s impossible to have two <code>tempBuffers</code> exist in the same line AND scope.</p>
<p>So we just concatenate <code>__LINE__</code> to <code>tempBuffer</code>. Simple right?</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp> <span style=color:teal>#define CreateStackString(Name, Num) char tempBuffer##__LINE__[Num] = {}; string Name = CreateString(tempBuffer##__LINE__, Num)
</span></code></pre></td></tr></table>
</div>
</div><p>Sadly, this does not work. According to be C99 specification in section 6.10.3.3, line 2:</p>
<p><code>If, in the replacement list of a function-like macro, a parameter is immediately precededor followed by a ## preprocessing token, the parameter is replaced by the corresponding argument’s preprocessing token sequence; however, if an argument consists of no preprocessing tokens, the parameter is replaced by a placemarker preprocessing token instead.</code></p>
<p>That means that when <code>##</code> is encountered, any macros on the left and right of it will not be evaluated. That means that this:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp> CreateStackString(Str1, <span style=color:#00f>256</span>);
</code></pre></td></tr></table>
</div>
</div><p>Would evaluate to something like this:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp> <span style=color:navy;font-weight:700>char</span> tempBuffer__LINE__[<span style=color:#00f>256</span>] = {}; string Name = CreateString(tempBuffer__LINE__, <span style=color:#00f>256</span>)
</code></pre></td></tr></table>
</div>
</div><p>Which means that we are back to square one. To solve this, a simple indirection trick can be used to <strong>force</strong> the <code>__LINE__</code> macro to evaluate (and by extension, any macro you want to evaluate that is part of an argument for the macro concatenation <code>##</code> syntax).</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:teal>#define glue_(a,b) a##b
</span><span style=color:teal>#define glue(a,b) glue_(a,b)
</span></code></pre></td></tr></table>
</div>
</div><p>Then we use the <code>glue</code> macro like this to solve our problem:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp> <span style=color:teal>#define CreateStackString(Name, Num) char glue(tempBuffer,__LINE__)[Num] = {}; string Name = CreateString(glue(tempBuffer,__LINE__), Num)
</span></code></pre></td></tr></table>
</div>
</div><p>For clarity, the macro expansion is as follows:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>CreateStackString(Str1, <span style=color:#00f>256</span>);
CreateStackString(Str2, <span style=color:#00f>128</span>);
CreateStackString(Str3, <span style=color:#00f>64</span>);
</code></pre></td></tr></table>
</div>
</div><p>expands to:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#080;font-style:italic>// Expand 1
</span><span style=color:#080;font-style:italic></span><span style=color:navy;font-weight:700>char</span> glue(tempBuffer,__LINE__)[<span style=color:#00f>256</span>] = {}; string Str1 = CreateString(glue(tempBuffer,__LINE__), <span style=color:#00f>256</span>);
<span style=color:navy;font-weight:700>char</span> glue(tempBuffer,__LINE__)[<span style=color:#00f>128</span>] = {}; string Str2 = CreateString(glue(tempBuffer,__LINE__), <span style=color:#00f>128</span>)
<span style=color:navy;font-weight:700>char</span> glue(tempBuffer,__LINE__)[<span style=color:#00f>64</span>] = {}; string Str3 = CreateString(glue(tempBuffer,__LINE__), <span style=color:#00f>64</span>)
</code></pre></td></tr></table>
</div>
</div><p>expands to:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:navy;font-weight:700>char</span> glue_(tempBuffer,<span style=color:#00f>1</span>)[<span style=color:#00f>256</span>] = {}; string Str1 = CreateString(glue(tempBuffer,<span style=color:#00f>1</span>), <span style=color:#00f>256</span>);
<span style=color:navy;font-weight:700>char</span> glue_(tempBuffer,<span style=color:#00f>2</span>)[<span style=color:#00f>128</span>] = {}; string Str2 = CreateString(glue(tempBuffer,<span style=color:#00f>2</span>), <span style=color:#00f>128</span>);
<span style=color:navy;font-weight:700>char</span> glue_(tempBuffer,<span style=color:#00f>3</span>)[<span style=color:#00f>64</span>] = {}; string Str3 = CreateString(glue(tempBuffer,<span style=color:#00f>3</span>), <span style=color:#00f>64</span>);
</code></pre></td></tr></table>
</div>
</div><p>which will finally expand to:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:navy;font-weight:700>char</span> tempBuffer1[<span style=color:#00f>256</span>] = {}; string Str1 = CreateString(tempBuffer1, <span style=color:#00f>256</span>);
<span style=color:navy;font-weight:700>char</span> tempBuffer2[<span style=color:#00f>128</span>] = {}; string Str2 = CreateString(tempBuffer2, <span style=color:#00f>128</span>);
<span style=color:navy;font-weight:700>char</span> tempBuffer3[<span style=color:#00f>64</span>] = {}; string Str3 = CreateString(tempBuffer3, <span style=color:#00f>64</span>);
</code></pre></td></tr></table>
</div>
</div><p>The trick is, in the end, not very complicated. It is just to get around the rather unintuitive specification in the C99 standard that states that arguments for <code>##</code> would not be evaluated.</p>
</p>
</div>
</div>
<footer>
<p classname=footer-copyright-text>
Powered By Hugo | v1.2 | © 2021 Gerald Wong
</p>
</footer>
</body>
</html>