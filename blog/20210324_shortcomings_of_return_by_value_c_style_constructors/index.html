<html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://www.w3schools.com/w3css/4/w3.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inconsolata"><link rel=stylesheet href=/css/common.css><link rel="shortcut icon" type=image/png href=/img/favicon.png><title>Gerald's Website</title><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div class=profile><a href=/><img class=profile-img-back src=/img/profile.jpg loading=lazy></a><div class=profile-text>Gerald's Stuff</div><div class=profile-subtext>Blog</div></div><div class=blog-container><div class=blog-body><h1 class=blog-content-title>A small shortcoming of return-by-value</h1><h4 class=blog-content-date><time datetime=2021-03-24T12:00:00+08:00>Mar 24, 2021</time></h4><p class=blog-content-body><p>Recently, while coding on my personal C/C++ game engine project, I ran into a surprising shortcoming of functions that returns an object by value. This was when I was still trying to keep things consistant in my project and went for a functional-programming style.</p><p>Consider that there are generally two simple ways to modify an object in C/C++ through plain functions.</p><p>Returning by value:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>v2f</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>v2f</span> <span class=nf>CreateV2f</span><span class=p>(</span><span class=kt>float</span> <span class=n>x</span><span class=p>,</span> <span class=kt>float</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v2f</span> <span class=p>{</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Usage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>v2f</span> <span class=n>Vec</span> <span class=o>=</span> <span class=n>CreateV2f</span><span class=p>(</span><span class=mf>1.f</span><span class=p>,</span> <span class=mf>2.f</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Modifying by pointer:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>v2f</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>InitV2f</span><span class=p>(</span><span class=n>v2f</span><span class=o>*</span> <span class=n>Vec</span><span class=p>,</span> <span class=kt>float</span> <span class=n>x</span><span class=p>,</span> <span class=kt>float</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Vec</span><span class=o>-&gt;</span><span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Vec</span><span class=o>-&gt;</span><span class=n>y</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Usage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>v2f</span> <span class=n>Vec</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=n>InitV2f</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Vec</span><span class=p>,</span> <span class=mf>1.f</span><span class=p>,</span> <span class=mf>2.f</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>We can spend hours arguing about which one is better, but optimization and code readability aside, we can all agree that both functions generally does the same thing, at a relatively good speed.</p><p>So I have been using both styles interchangably for awhile now. Some scenarios, I feel like the first method is better while other times, the second feels better. Generally, it felt like both methods are interchangable. I ended up just going for the return-by-value style because copy elision is a thing. I did not profile the performance differences between the two styles so call it &lsquo;premature optimization&rsquo; if you will, but I just wanted some consistency in my code.</p><p>However I found a <em>slightly</em> unexpected shortcoming of the return-by-value method. Consider the scenario:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// Simple lightweight &#39;string&#39; object.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=nf>CreateString</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>cap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>ret</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span><span class=p>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span><span class=p>.</span><span class=n>cap</span> <span class=o>=</span> <span class=n>cap</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>StringWithBuffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>str</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>StringWithBuffer</span> <span class=nf>CreateStringWithBuffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>StringWithBuffer</span> <span class=n>ret</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span><span class=p>.</span><span class=n>str</span> <span class=o>=</span> <span class=n>CreateString</span><span class=p>(</span><span class=n>ret</span><span class=p>.</span><span class=n>buffer</span><span class=p>,</span> <span class=mi>256</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Usage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>StringWithBuffer</span> <span class=n>foo</span> <span class=o>=</span> <span class=n>CreateStringWithBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// foo.str.data will not point to foo.str.buffer!
</span></span></span></code></pre></td></tr></table></div></div><p>After calling <code>CreateStringWithBuffer()</code>, <code>foo.str.data</code> member will be pointing at an invalid address and not <code>foo.buffer</code>! This is obvious when you work out what happened step by step. Within <code>CreateStringWithBuffer()</code>, <code>ret.str.data</code> would end up correctly pointing to <code>ret.buffer</code>. However, <code>ret</code> is actually a temporary object, so <code>ret.buffer</code> will naturally become invalid after the function is done. It&rsquo;s obvious after pointing it out, but I think it&rsquo;s fair to say that most of us thought that there would not be a problem with <code>CreateStringWithBuffer()</code>, because it looks so straightforward and simple.</p><p>Thinking about it, C++ constructors will never have this issue because you are modifying <code>this</code> and returns a reference to itself. (However, I have a lot of things against C++ constructors, which I might go into another article when I can).</p><p>Thankfully, the pointer version will not have the issue:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// Simple lightweight &#39;string&#39; object.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=nf>CreateString</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>cap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>ret</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span><span class=p>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span><span class=p>.</span><span class=n>cap</span> <span class=o>=</span> <span class=n>cap</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>StringWithBuffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>str</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>CreateStringWithBuffer</span><span class=p>(</span><span class=n>StringWithBuffer</span><span class=o>*</span> <span class=n>Foo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=o>-&gt;</span><span class=n>Str</span> <span class=o>=</span> <span class=n>CreateString</span><span class=p>(</span><span class=n>Foo</span><span class=o>-&gt;</span><span class=n>Buffer</span><span class=p>,</span> <span class=mi>256</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Usage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>StringWithBuffer</span> <span class=n>foo</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=n>CreateStringWithBuffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>foo</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// foo.str.data correctly points to foo.str.buffer!
</span></span></span></code></pre></td></tr></table></div></div><p>In the end, I really shouldn&rsquo;t have cared that much.</p></p></div></div><footer><p classname=footer-copyright-text>Powered By Hugo | v1.2 | © 2021 Gerald Wong</p></footer></body></html>